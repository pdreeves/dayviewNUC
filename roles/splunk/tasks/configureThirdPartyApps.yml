---

- name: Find all apps to install
  delegate_to: localhost
  find:
    paths: roles/splunk/files/apps/
    patterns: '*.tgz'
  register: splunkAppsToDeploy

- name: Copy app to deploy to server
  copy:
    dest: "/opt/splunk/apps/{{ item['path'][24:] }}"
    src: "{{ item['path']  }}"
  with_items: 
    - "{{ splunkAppsToDeploy['files'] }}"

- name: Uncompress splunkAppsToDeploy
  shell: "tar zxf /opt/splunk/apps/{{ item['path'][24:] }} -C /opt/splunk/apps"
  with_items: "{{ splunkAppsToDeploy['files'] }}"

- name: Find all apps to remove files from
  find:
    paths: /opt/splunk/apps
    file_type: directory
  register: appsDeploying

- name: Remove un-needed files from app
  ignore_errors: true
  file:
    path: "{{ item[0]['path'][17:] }}/{{ item[1] }}"
    state: absent
  with_nested:
    - "{{ appsDeploying['files'] }}"
    - ['default/database.conf', 'default/eventgen.conf', 'default/indexes.conf', 'default/inputs.conf', 'README/inputs.conf.spec', 'samples', 'default/web.conf']

- name: Back up local folder on container
  shell: docker container exec -u splunk splunk cp -R /opt/splunk/etc/apps/{{ item['path'][17:] }}/local /opt/splunk/etc/apps/backup/{{ item['path'][17:] }}/local
  ignore_errors: true
  with_items: 
    - "{{ appsDeploying['files'] }}"

- name: Copy app from server to container
  shell: docker container cp /opt/splunk/apps/{{ item['path'][17:] }} splunk:/opt/splunk/etc/apps/
  notify: Restart Splunk in container
  with_items: 
    - "{{ appsDeploying['files'] }}"

- name: Make local folder 
  shell: docker container exec -u splunk splunk mkdir /opt/splunk/etc/apps/{{ item['path'][17:] }}/local 
  ignore_errors: true
  with_items: 
    - "{{ appsDeploying['files'] }}"

- name: Copy local folder from backup to app
  shell: docker container exec -u splunk splunk cp -R /opt/splunk/etc/apps/backup/{{ item['path'][17:] }}/local /opt/splunk/etc/apps/{{ item['path'][17:] }}/local 
  ignore_errors: true
  with_items: 
    - "{{ appsDeploying['files'] }}"

- name: Delete app to upgrade on server
  file:
    state: absent
    path: "/opt/splunk/{{ item['path'][17:] }}/"
  with_items: 
    - "{{ appsDeploying['files'] }}"

- name: Delete backed up local folder in container
  shell: docker container exec -u splunk splunk rm -rf /opt/splunk/etc/apps/backup/{{ item['path'][17:] }}/local
  with_items: 
    - "{{ appsDeploying['files'] }}"

- name: Remove all apps from server
  shell: rm -rf /opt/splunk/etc/apps/*